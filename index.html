<!DOCTYPE html>
<html>
<head>
<title>Pomodorock</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="./static/css/bootstrap.min.css" rel="stylesheet" media="screen">
<link href="./static/css/bootstrap-responsive.min.css" rel="stylesheet" media="screen">
<link href="./static/css/font-awesome.css" rel="stylesheet" media="screen">
<style>
@import url(http://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic);
	body {
		font-family: "Lato","Helvetica Neue",Helvetica,Arial,sans-serif;
	}
	.container {
		min-height: 100%;
	}
	.alert {
		font-variant: small-caps;
	}
	.page-footer {
		position: fixed;
		bottom: 0;
		padding-top: 1em;
   		border-top: 1px solid #aaa;
   	}
   	section {
   		margin-bottom: .5em;
   	}
</style>
</head>
<body>
	<div class="container">
		<section class="page-header">
		<h1>Welcome to your Pomodorock Board!</h1>
		</section>

		<div id="timer-alert-pomodoro" class="alert alert-block alert-error fade in hide">
			<strong>Pomodoro is done! Now, have a short break.</strong>
		</div>

		<div id="timer-alert-break" class="alert alert-block alert-success fade in hide">
			<strong>Break is over. Now back to work...</strong>
		</div>

		<div id="db-migration-alert" class="alert alert-block alert-error fade in hide">
			<strong>DB Migration error</strong>: Please send <a href="https://github.com/brunobord/pomodorock/issues">a bug report</a>.
		</div>

		<section class="row">
			<div class="span4">
				<h3>Timer</h3>
				<div class="btn-toolbar">
					<button data-time="25" data-alert-name="pomodoro" title="25mn work" class="btn-start btn"><i class="icon-laptop icon-white"></i></button>
					<button data-time="5" data-alert-name="break" title="5mn short break" class="btn-start btn"><i class="icon-coffee icon-white"></i></button>
					<button data-time="30" data-alert-name="break" title="30mn long break" class="btn-start btn"><i class="icon-rocket icon-white"></i></button>
					<button id="btn-stop" class="btn btn-warning"><i class="icon-stop"></i> </button>
				</div>
				<div>
					<i class="icon-time"></i> <span id="time">waiting...</span>
				</div>
				<div class="bar"></div>
			</div>

			<div class="span4">
				<h1 id="pomodoros"></h1>
				<p>Pomodoros</p>
				<button class="btn incr btn-primary btn-large" data-target="pomodoros"><i class="icon-plus icon-white"></i></button>
				<button class="btn decr btn-danger btn-small" data-target="pomodoros"><i class="icon-minus icon-white"></i></button>

			</div>
			<div class="span4">
				<h1 id="interruptions"></h1>
				<p>Interruptions</p>
				<button class="btn incr btn-primary btn-large" data-target="interruptions"><i class="icon-plus icon-white"></i></button>
				<button class="btn decr btn-danger btn-small" data-target="interruptions"><i class="icon-minus icon-white"></i></button>
			</div>
		</section>

		<section class="row">
			<div class="span12">
				<button class="btn" id="db-operations"><i class="icon-hdd"></i> DB operations</button>
			</div>
		</section>

		<section class="row">
			<div class="span3">
				<div class="hide db-operations">
					<h3>Database operations</h3>
					<button id="backup" class="btn"><i class="icon-share"></i> Backup</button>
					<button id="restore-start" class="btn"><i class="icon-download-alt"></i> Restore</button>
				</div>
			</div>

			<div class="span9">
				<p class="on-backup hide">Copy-paste this text and store it somewhere to backup your DB.</p>
				<p class="alert alert-error on-backup hide">Keep it <strong>INTACT</strong>, or you'll be in <strong>TROUBLE</strong>.</p>
				<p class="alert alert-info on-restore hide">Paste your previous backup here and click on "Restore Me"</p>
				<textarea name="dbcontent" id="dbcontent" rows="10" class="hide span9"></textarea>
				<p><button id="restore" class="btn btn-danger on-restore hide"><i class="icon-download-alt icon-white"></i> Restore Me</button></p>
			</div>
		</section>

		<section class="page-footer row">
			<p><a href="http://brunobord.github.io/pomodorock">Pomodorock</a> v<span id="version"></span> is &copy; 2013 - Bruno Bord - If you use me, please star me on <a href="https://github.com/brunobord/pomodorock/">Github</a>. Pomodorock is Free Software and keeps <em>zero knowledge</em> of your data on the server-side.
			</p>
		</section>
	</div>


<script src="./static/js/jquery.min.js"></script>
<script src="./static/js/bootstrap.min.js"></script>
<script src="./static/js/moment.min.js"></script>
<script src="./static/js/jquery.sparkline.min.js"></script>
<script src="./static/js/bankersbox.min.js"></script>
<script>
// variable initialization
var time = moment().startOf('hour').add('minutes', 25);
var alert_name = "pomodoro";
var interval;
var bb = new BankersBox();

// Prototyping the localStorage object
Object.getPrototypeOf(localStorage).dumps = function() {
	return JSON.stringify(this);
};
Object.getPrototypeOf(localStorage).loads = function(str, clear) {
	if (clear == true)
		this.clear();
	var doc = JSON.parse(str);
	for (var key in Object.keys(doc)) {
		this.setItem(key, doc[key]);
	};
};

/*
 * zips arrays into one
 */
function zip(arrays) {
    return arrays[0].map(function(_,i){
        return arrays.map(function(array){return array[i]})
    });
}

// -------- Database section
// current version
var __version__ = '1.0.1';
var __versions__ = {
    '1.0.1': migrate_1_0_1,
}
function migrate_1_0_1() {
    // v1.0.1 -  goal is to build a set of dates - each time we're adding a
    // pomodoro or an interruption, we're adding this date to the set.
	var regDate = '^([0-9]{4})-([0-9]{2})-([0-9]{2})';
	for (var i in bb.keys()) {
		key = bb.keys()[i];
		if (key.match(regDate)) {
			var date = key.slice(0, 10);
			bb.sadd('index:dates', date);
		}
	}
    return true;
}
function migrate() {
	if (!bb.exists('db:version')) {
		bb.set('db:version', '1.0.0');
	}
	for (var version in __versions__) {
		var current_version = bb.get('db:version');
		if (version > current_version) {
			var callback = __versions__[version];
			if (callback()) {
				bb.set('db:version', version);
			}
		}
	};
	// Check if everything's okay
	if (bb.get('db:version') != __version__) {
		$('#db-migration-alert').show();
	}
	$('#version').html(bb.get('db:version'));
}

/*
 * Increment counter (pomodoros or interruptions)
 */
function incrementCounter(element) {
	var target = element.attr("data-target");
	bb.incr(getKey(target));
	bb.sadd('index:dates', moment().format('YYYY-MM-DD'));
	refresh();
}

/*
 * Decrement counter
 */
function decrementCounter(element) {
	var target = $(element).attr("data-target");
	bb_key = getKey(target);
	if (bb.get(bb_key) == 0) return;
	bb.decr(bb_key);
	refresh();
}

/*
 * Helper: get the BankersBox key
 */
function getKey(key) {
	return moment().format('YYYY-MM-DD') + ':' + key;
}

// -------- UI section

/*
 * refresh Counter on the webpage
 */
function refreshKey(key) {
	var bb_key = getKey(key);
	bb.sadd('index:dates', moment().format('YYYY-MM-DD'));
	if (!bb.exists(bb_key)) {
		bb.set(bb_key, 0);
	}
	$('#'+key).html(bb.get(bb_key));
}

/*
 * Refresh stats (sparklines)
 */
function getStats() {
	var pomodoros = [];
	var interruptions = [];
	var dates = bb.smembers('index:dates');
	dates.sort();
	dates = dates.slice(-20);
	for (var i in dates) {
		key = dates[i];
		if (bb.exists(key+':pomodoros')) {
			pomodoros.push(bb.get(key+':pomodoros'));
		} else {
			pomodoros.push(0);
		}
		if (bb.exists(key+':interruptions')) {
			interruptions.push(bb.get(key+':interruptions'));
		} else {
			interruptions.push(0);
		}
	};

	var data = zip([pomodoros, interruptions]);

	$('.bar').sparkline(data, { type: 'bar' });
}

/*
 * Full refresh of the counters and stats on the UI
 */
function refresh() {
	refreshKey('pomodoros');
	refreshKey('interruptions');
	getStats();
}

// -------- Timer section

/*
 * Update timer on the UI
 */
function updateTimer() {
	time.subtract(1, 'seconds');
	$('#time').html(time.format('mm:ss'));
	document.title = time.format('mm:ss') + " - Pomodorock";
	if (time.minute() == 0 && time.seconds() == 0) {
		notify();
		resetTimer();
		document.title = "DONE - Pomodorock";
	}
}
/*
 * Reset timer
 */
function resetTimer() {
	$('#time').html('waiting...');
	clearInterval(interval);
}

/*
 * Trigger notification (visual and audio)
 */
function notify() {
	$('#timer-alert-'+alert_name).show();
	var snd = new Audio("./static/tada.wav");
	snd.play();
}


$(document).ready(function() {

	migrate();
	refresh();

	// Start button event
	$('.btn-start').click(function() {
		// Hide alerts
		$('.alert').hide();
		// initialize timer
		time = moment().startOf('hour').add('minutes', $(this).attr('data-time'));
		// This "alert_name" object will be shown when the timer will be over.
		alert_name = $(this).attr('data-alert-name');
		$('#time').html(time.format('mm:ss'));
		// Interval call.
		interval = setInterval("updateTimer()", 1000);
	});

	// Stop button event
	$('#btn-stop').click(function() {
		$('.alert').hide();
		document.title = "Pomodorock";
		resetTimer();
	})

	// Increment button event
	$('.incr').click(function() {
		incrementCounter($(this));
	});
	// Decrement button event
	$('.decr').click(function() {
		decrementCounter($(this))
	});

	// DB Operation button event
	$('#db-operations').click(function() {
		$('.db-operations').toggle();
		$('.on-restore, .on-backup, textarea#dbcontent, .dbcontent').hide();
	});
	// DB Backup button event
	$('#backup').click(function() {
		$('textarea#dbcontent').val(localStorage.dumps()); // DB serialization
		$('.on-restore').hide();
		$('.on-backup, textarea#dbcontent').show();
	});
	// DB Restore "start" button event - display restore interface
	$('#restore-start').click(function() {
		$('.on-backup').hide();
		$('.on-restore, textarea#dbcontent').show();
	});
	// Restore button event.
	$('#restore').click(function() {
		localStorage.loads($('textarea#dbcontent').val());
		// Note: this looks like a dirty trick, but it looks like calling refresh()
		// does not refresh the counter correctly.
		// FIXME: find a better way.
		var timeId = window.setTimeout(function() {document.location.href = '.';}, 1500);
	})

});

</script>
</body>
</html>
